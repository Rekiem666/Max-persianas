<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MAX — Persianas</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MAX">
<meta name="theme-color" content="#0c0c14">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBjMGMxNCIvPgogIDxkZWZzPgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJnIiB4MT0iMCIgeTE9IjAiIHgyPSI1MTIiIHkyPSI1MTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzFjMWMyZSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwYzBjMTQiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSJ1cmwoI2cpIi8+CiAgPHRleHQgeD0iMjU2IiB5PSIzMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCBCbGFjaywgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIgZm9udC1zaXplPSIyMjAiIGZpbGw9IiM3YzZiZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGxldHRlci1zcGFjaW5nPSItOCI+TUFYPC90ZXh0PgogIDxyZWN0IHg9IjgwIiB5PSIzNjAiIHdpZHRoPSIzNTIiIGhlaWdodD0iNiIgcng9IjMiIGZpbGw9IiMwMGU1YTAiIG9wYWNpdHk9IjAuOCIvPgo8L3N2Zz4=">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBjMGMxNCIvPgogIDxkZWZzPgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJnIiB4MT0iMCIgeTE9IjAiIHgyPSI1MTIiIHkyPSI1MTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzFjMWMyZSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwYzBjMTQiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSJ1cmwoI2cpIi8+CiAgPHRleHQgeD0iMjU2IiB5PSIzMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCBCbGFjaywgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIgZm9udC1zaXplPSIyMjAiIGZpbGw9IiM3YzZiZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGxldHRlci1zcGFjaW5nPSItOCI+TUFYPC90ZXh0PgogIDxyZWN0IHg9IjgwIiB5PSIzNjAiIHdpZHRoPSIzNTIiIGhlaWdodD0iNiIgcng9IjMiIGZpbGw9IiMwMGU1YTAiIG9wYWNpdHk9IjAuOCIvPgo8L3N2Zz4=">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
:root { --bg: #0c0c14; --surface: #13131f; --surface2: #1c1c2e; --border: #2a2a40; --accent: #7c6bff; --green: #00e5a0; --yellow: #ffcc47; --red: #ff5c6b; --orange: #ff8c42; --text: #e8e8f4; --muted: #5a5a7a; --radius: 14px; }
* { margin:0; padding:0; box-sizing:border-box; }
body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; min-height: 100vh; }
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; }
.logo span { color: var(--accent); }
.tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 2px; overflow-x: auto; }
.tab { padding: 10px 14px; font-size: 12px; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.page { display: none; padding: 20px; max-width: 900px; margin: 0 auto; }
.page.active { display: block; }
.semaforo { background: linear-gradient(135deg, #13131f 0%, #1c1c2e 100%); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.necesitas { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; }
.metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.metric-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
.table-container { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 10px 14px; font-size: 10px; color: var(--muted); background: var(--surface2); }
td { padding: 10px 14px; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.04); }
.chat-wrap { display: flex; flex-direction: column; height: calc(100vh - 160px); }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px 0; display: flex; flex-direction: column; gap: 12px; }
.msg { display: flex; gap: 10px; }
.msg.user { flex-direction: row-reverse; }
.msg-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-weight: 700; }
.msg.user .msg-avatar { background: var(--accent); color: white; }
.msg.max .msg-avatar { background: var(--green); color: #0c0c14; }
.msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.6; background: var(--surface); border: 1px solid var(--border); }
.msg.user .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.chat-input-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: flex-end; gap: 10px; padding: 10px 14px; }
.chat-input { flex: 1; background: transparent; border: none; color: var(--text); outline: none; resize: none; font-family: 'DM Sans', sans-serif; }
.chat-send { background: var(--accent); border: none; border-radius: 10px; width: 36px; height: 36px; color: white; cursor: pointer; }
.typing { display: flex; gap: 4px; padding: 10px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; width: fit-content; }
.typing span { width: 6px; height: 6px; background: var(--muted); border-radius: 50%; animation: bounce 1.2s infinite; }
@keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
</style>
</head>
<body>

<header>
  <div class="logo">MAX <span>●</span> Persianas</div>
  <div class="fecha" id="fechaHoy"></div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
  <div class="tab" onclick="showTab('max')">⚡ MAX</div>
  <div class="tab" onclick="showTab('leads')">Leads</div>
  <div class="tab" onclick="showTab('ventas')">Ventas</div>
</div>

<div class="page active" id="page-dashboard">
  <div class="semaforo">
    <div class="necesitas" id="necesitas-val">$0</div>
    <div id="estado-badge" class="badge">Cargando datos...</div>
  </div>
  <div class="metrics-grid">
    <div class="metric-card"><div>Total Ventas</div><div id="m-ventas-total">$0</div></div>
    <div class="metric-card"><div>Leads Hoy</div><div id="m-leads-total">0</div></div>
  </div>
</div>

<div class="page" id="page-max">
  <div class="chat-wrap">
    <div class="chat-messages" id="chat-messages">
      <div class="msg max"><div class="msg-avatar">M</div><div class="msg-bubble">Hola. Soy MAX. Dime qué pasó hoy.</div></div>
    </div>
    <div class="chat-input-wrap">
      <textarea class="chat-input" id="chat-input" placeholder="Dime qué pasó..." rows="1"></textarea>
      <button class="chat-send" onclick="sendMessage()">↑</button>
    </div>
  </div>
</div>

<div class="page" id="page-leads">
  <div class="table-container">
    <table>
      <thead><tr><th>Fecha</th><th>Nombre</th><th>Canal</th><th>Producto</th><th>Status</th><th>Cotización</th></tr></thead>
      <tbody id="leads-tbody"></tbody>
    </table>
  </div>
</div>

<div class="page" id="page-ventas">
  <div class="table-container">
    <table>
      <thead><tr><th>Fecha</th><th>Cliente</th><th>Producto</th><th>Monto</th><th>Factura</th><th>Status</th></tr></thead>
      <tbody id="ventas-tbody"></tbody>
    </table>
  </div>
</div>

<script>
const APPS_URL = 'https://script.google.com/macros/s/AKfycbxUZgf880vovrTfD8b3QZEXxe7wmXytv1UnLDGvl6jeBWwges6U3u-jAepyzYG8yld4Og/exec';
const MAX_SYSTEM = `Eres MAX, asistente financiero. Responde siempre en JSON.`;

let data = { leads: [], ventas: [], pagos: [], gastos: [] };

function fmt(n) { return new Intl.NumberFormat('es-MX', {style:'currency',currency:'MXN',minimumFractionDigits:0}).format(n||0); }

function showTab(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
  renderAll();
}

async function loadFromSheets() {
  try {
    const res = await fetch(APPS_URL + '?action=getData');
    const json = await res.json();
    if(json.ok && json.data) {
      data.leads = json.data.LEADS || [];
      data.ventas = json.data.VENTAS || [];
      renderAll();
    }
  } catch(e) { console.error(e); }
}

function renderAll() {
  const vTotal = data.ventas.reduce((s,v)=>s+(parseFloat(v.Monto)||0),0);
  document.getElementById('m-ventas-total').textContent = fmt(vTotal);
  document.getElementById('m-leads-total').textContent = data.leads.length;
  document.getElementById('leads-tbody').innerHTML = data.leads.map(l=>`<tr><td>${l.Fecha}</td><td>${l.Nombre}</td><td>${l.Canal}</td><td>${l.Producto}</td><td>${l.Status}</td><td>${fmt(l.Cotización)}</td></tr>`).join('');
  document.getElementById('ventas-tbody').innerHTML = data.ventas.map(v=>`<tr><td>${v.Fecha}</td><td>${v.Cliente}</td><td>${v.Producto}</td><td>${fmt(v.Monto)}</td><td>${v.Factura}</td><td>${v.Status}</td></tr>`).join('');
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if(!text) return;

  addMsg('user', text);
  input.value = '';
  showTyping();

  try {
    const res = await fetch('/.netlify/functions/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-3-5-haiku-20241022',
        max_tokens: 500,
        system: MAX_SYSTEM,
        messages: [{ role: 'user', content: text }]
      })
    });

    const json = await res.json();
    hideTyping();

    // ANALIZAMOS LA RESPUESTA REAL
    if (json.error) {
       addMsg('max', 'Error Anthropic: ' + (json.error.message || JSON.stringify(json.error)));
       return;
    }

    if (json.content && json.content[0]) {
      try {
        const raw = json.content[0].text;
        const parsed = JSON.parse(raw.replace(/```json|```/g, '').trim());
        addMsg('max', parsed.confirmacion);
      } catch(e) {
        addMsg('max', 'Error formato JSON: ' + json.content[0].text);
      }
    } else {
      addMsg('max', 'Respuesta inesperada: ' + JSON.stringify(json));
    }

  } catch(err) {
    hideTyping();
    addMsg('max', 'Error técnico: ' + err.message);
  }
}

function addMsg(role, text) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.innerHTML = `<div class="msg-avatar">${role==='user'?'T':'M'}</div><div class="msg-bubble">${text}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.id = 'typing'; div.className = 'msg max';
  div.innerHTML = '<div class="msg-avatar">M</div><div class="typing"><span></span><span></span><span></span></div>';
  msgs.appendChild(div);
}

function hideTyping() { const el = document.getElementById('typing'); if(el) el.remove(); }

window.onload = () => { loadFromSheets(); };
</script>
</body>
</html>
